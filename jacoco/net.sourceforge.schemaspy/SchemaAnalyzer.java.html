<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaAnalyzer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SchemaSpy Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.schemaspy</a> &gt; <span class="el_source">SchemaAnalyzer.java</span></div><h1>SchemaAnalyzer.java</h1><pre class="source lang-java linenums">/*
 * This file is a part of the SchemaSpy project (http://schemaspy.sourceforge.net).
 * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2009, 2010 John Currier
 *
 * SchemaSpy is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * SchemaSpy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */
package net.sourceforge.schemaspy;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URL;
import java.net.URLClassLoader;
import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.Driver;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Properties;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.logging.ConsoleHandler;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import net.sourceforge.schemaspy.model.ConnectionFailure;
import net.sourceforge.schemaspy.model.Database;
import net.sourceforge.schemaspy.model.EmptySchemaException;
import net.sourceforge.schemaspy.model.ForeignKeyConstraint;
import net.sourceforge.schemaspy.model.ImpliedForeignKeyConstraint;
import net.sourceforge.schemaspy.model.InvalidConfigurationException;
import net.sourceforge.schemaspy.model.Table;
import net.sourceforge.schemaspy.model.TableColumn;
import net.sourceforge.schemaspy.model.xml.SchemaMeta;
import net.sourceforge.schemaspy.util.ConnectionURLBuilder;
import net.sourceforge.schemaspy.util.DOMUtil;
import net.sourceforge.schemaspy.util.DbSpecificOption;
import net.sourceforge.schemaspy.util.Dot;
import net.sourceforge.schemaspy.util.LineWriter;
import net.sourceforge.schemaspy.util.LogFormatter;
import net.sourceforge.schemaspy.util.PasswordReader;
import net.sourceforge.schemaspy.util.ResourceWriter;
import net.sourceforge.schemaspy.view.DotFormatter;
import net.sourceforge.schemaspy.view.HtmlAnomaliesPage;
import net.sourceforge.schemaspy.view.HtmlColumnsPage;
import net.sourceforge.schemaspy.view.HtmlConstraintsPage;
import net.sourceforge.schemaspy.view.HtmlMainIndexPage;
import net.sourceforge.schemaspy.view.HtmlOrphansPage;
import net.sourceforge.schemaspy.view.HtmlRelationshipsPage;
import net.sourceforge.schemaspy.view.HtmlTablePage;
import net.sourceforge.schemaspy.view.ImageWriter;
import net.sourceforge.schemaspy.view.StyleSheet;
import net.sourceforge.schemaspy.view.TextFormatter;
import net.sourceforge.schemaspy.view.WriteStats;
import net.sourceforge.schemaspy.view.XmlTableFormatter;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

/**
 * @author John Currier
 */
<span class="fc" id="L79">public class SchemaAnalyzer {</span>
<span class="fc" id="L80">    private final Logger logger = Logger.getLogger(getClass().getName());</span>
    private boolean fineEnabled;

    public Database analyze(Config config) throws Exception {
        try {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">            if (config.isHelpRequired()) {</span>
<span class="nc" id="L86">                config.dumpUsage(null, false);</span>
<span class="nc" id="L87">                return null;</span>
            }

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">            if (config.isDbHelpRequired()) {</span>
<span class="nc" id="L91">                config.dumpUsage(null, true);</span>
<span class="nc" id="L92">                return null;</span>
            }

            // set the log level for the root logger
<span class="fc" id="L96">            Logger.getLogger(&quot;&quot;).setLevel(config.getLogLevel());</span>

            // clean-up console output a bit
<span class="fc bfc" id="L99" title="All 2 branches covered.">            for (Handler handler : Logger.getLogger(&quot;&quot;).getHandlers()) {</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">                if (handler instanceof ConsoleHandler) {</span>
<span class="fc" id="L101">                    ((ConsoleHandler)handler).setFormatter(new LogFormatter());</span>
<span class="fc" id="L102">                    handler.setLevel(config.getLogLevel());</span>
                }
            }

<span class="fc" id="L106">            fineEnabled = logger.isLoggable(Level.FINE);</span>
<span class="fc" id="L107">            logger.info(&quot;Starting schema analysis&quot;);</span>

<span class="fc" id="L109">            long start = System.currentTimeMillis();</span>
<span class="fc" id="L110">            long startDiagrammingDetails = start;</span>
<span class="fc" id="L111">            long startSummarizing = start;</span>

<span class="fc" id="L113">            File outputDir = config.getOutputDir();</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">            if (!outputDir.isDirectory()) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                if (!outputDir.mkdirs()) {</span>
<span class="nc" id="L116">                    throw new IOException(&quot;Failed to create directory '&quot; + outputDir + &quot;'&quot;);</span>
                }
            }

<span class="fc" id="L120">            List&lt;String&gt; schemas = config.getSchemas();</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            if (schemas != null) {</span>
<span class="nc" id="L122">                List&lt;String&gt; args = config.asList();</span>

                // following params will be replaced by something appropriate
<span class="nc" id="L125">                yankParam(args, &quot;-o&quot;);</span>
<span class="nc" id="L126">                yankParam(args, &quot;-s&quot;);</span>
<span class="nc" id="L127">                args.remove(&quot;-all&quot;);</span>
<span class="nc" id="L128">                args.remove(&quot;-schemas&quot;);</span>
<span class="nc" id="L129">                args.remove(&quot;-schemata&quot;);</span>

<span class="nc" id="L131">                String dbName = config.getDb();</span>

<span class="nc" id="L133">                MultipleSchemaAnalyzer.getInstance().analyze(dbName, schemas, args, config.getUser(), outputDir, config.getCharset(), Config.getLoadedFromJar());</span>
<span class="nc" id="L134">                return null;</span>
            }

<span class="fc" id="L137">            Properties properties = config.getDbProperties(config.getDbType());</span>

<span class="fc" id="L139">            ConnectionURLBuilder urlBuilder = new ConnectionURLBuilder(config, properties);</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            if (config.getDb() == null)</span>
<span class="nc" id="L141">                config.setDb(urlBuilder.getConnectionURL());</span>

<span class="fc bfc" id="L143" title="All 2 branches covered.">            if (config.getRemainingParameters().size() != 0) {</span>
<span class="fc" id="L144">                StringBuilder msg = new StringBuilder(&quot;Unrecognized option(s):&quot;);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">                for (String remnant : config.getRemainingParameters())</span>
<span class="fc" id="L146">                    msg.append(&quot; &quot; + remnant);</span>
<span class="fc" id="L147">                logger.warning(msg.toString());</span>
            }

<span class="fc" id="L150">            String driverClass = properties.getProperty(&quot;driver&quot;);</span>
<span class="fc" id="L151">            String driverPath = properties.getProperty(&quot;driverPath&quot;);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            if (driverPath == null)</span>
<span class="fc" id="L153">                driverPath = &quot;&quot;;</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">            if (config.getDriverPath() != null)</span>
<span class="fc" id="L155">                driverPath = config.getDriverPath() + File.pathSeparator + driverPath;</span>

<span class="fc" id="L157">            Connection connection = getConnection(config, urlBuilder.getConnectionURL(), driverClass, driverPath);</span>

<span class="fc" id="L159">            DatabaseMetaData meta = connection.getMetaData();</span>
<span class="fc" id="L160">            String dbName = config.getDb();</span>
<span class="fc" id="L161">            String schema = config.getSchema();</span>

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (config.isEvaluateAllEnabled()) {</span>
<span class="nc" id="L164">                List&lt;String&gt; args = config.asList();</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                for (DbSpecificOption option : urlBuilder.getOptions()) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                    if (!args.contains(&quot;-&quot; + option.getName())) {</span>
<span class="nc" id="L167">                        args.add(&quot;-&quot; + option.getName());</span>
<span class="nc" id="L168">                        args.add(option.getValue().toString());</span>
                    }
<span class="nc" id="L170">                }</span>

<span class="nc" id="L172">                yankParam(args, &quot;-o&quot;);  // param will be replaced by something appropriate</span>
<span class="nc" id="L173">                yankParam(args, &quot;-s&quot;);  // param will be replaced by something appropriate</span>
<span class="nc" id="L174">                args.remove(&quot;-all&quot;);    // param will be replaced by something appropriate</span>

<span class="nc" id="L176">                String schemaSpec = config.getSchemaSpec();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">                if (schemaSpec == null)</span>
<span class="nc" id="L178">                    schemaSpec = properties.getProperty(&quot;schemaSpec&quot;, &quot;.*&quot;);</span>
<span class="nc" id="L179">                MultipleSchemaAnalyzer.getInstance().analyze(dbName, meta, schemaSpec, null, args, config.getUser(), outputDir, config.getCharset(), Config.getLoadedFromJar());</span>
<span class="nc" id="L180">                return null;    // no database to return</span>
            }

<span class="pc bpc" id="L183" title="2 of 4 branches missed.">            if (schema == null &amp;&amp; meta.supportsSchemasInTableDefinitions() &amp;&amp;</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">                    !config.isSchemaDisabled()) {</span>
<span class="nc" id="L185">                schema = config.getUser();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (schema == null)</span>
<span class="nc" id="L187">                    throw new InvalidConfigurationException(&quot;Either a schema ('-s') or a user ('-u') must be specified&quot;);</span>
<span class="nc" id="L188">                config.setSchema(schema);</span>
            }

<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            SchemaMeta schemaMeta = config.getMeta() == null ? null : new SchemaMeta(config.getMeta(), dbName, schema);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (config.isHtmlGenerationEnabled()) {</span>
<span class="fc" id="L193">                new File(outputDir, &quot;tables&quot;).mkdirs();</span>
<span class="fc" id="L194">                new File(outputDir, &quot;diagrams/summary&quot;).mkdirs();</span>

<span class="fc" id="L196">                logger.info(&quot;Connected to &quot; + meta.getDatabaseProductName() + &quot; - &quot; + meta.getDatabaseProductVersion());</span>

<span class="pc bpc" id="L198" title="3 of 4 branches missed.">                if (schemaMeta != null &amp;&amp; schemaMeta.getFile() != null) {</span>
<span class="nc" id="L199">                    logger.info(&quot;Using additional metadata from &quot; + schemaMeta.getFile());</span>
                }

<span class="fc" id="L202">                logger.info(&quot;Gathering schema details&quot;);</span>

<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L205">                    System.out.print(&quot;Gathering schema details...&quot;);</span>
            }

            //
            // create our representation of the database
            //
<span class="fc" id="L211">            Database db = new Database(config, connection, meta, dbName, schema, properties, schemaMeta);</span>

<span class="fc" id="L213">            schemaMeta = null; // done with it so let GC reclaim it</span>

            LineWriter out;
<span class="fc" id="L216">            Collection&lt;Table&gt; tables = new ArrayList&lt;Table&gt;(db.getTables());</span>
<span class="fc" id="L217">            tables.addAll(db.getViews());</span>

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">            if (tables.isEmpty()) {</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                dumpNoTablesMessage(schema, config.getUser(), meta, config.getTableInclusions() != null);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (!config.isOneOfMultipleSchemas()) // don't bail if we're doing the whole enchilada</span>
<span class="nc" id="L222">                    throw new EmptySchemaException();</span>
            }

<span class="fc" id="L225">            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L226">            DocumentBuilder builder = factory.newDocumentBuilder();</span>
<span class="fc" id="L227">            Document document = builder.newDocument();</span>
<span class="fc" id="L228">            Element rootNode = document.createElement(&quot;database&quot;);</span>
<span class="fc" id="L229">            document.appendChild(rootNode);</span>
<span class="fc" id="L230">            DOMUtil.appendAttribute(rootNode, &quot;name&quot;, dbName);</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">            if (schema != null)</span>
<span class="nc" id="L232">                DOMUtil.appendAttribute(rootNode, &quot;schema&quot;, schema);</span>
<span class="fc" id="L233">            DOMUtil.appendAttribute(rootNode, &quot;type&quot;, db.getDatabaseProduct());</span>

<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            if (config.isHtmlGenerationEnabled()) {</span>
<span class="fc" id="L236">                startSummarizing = System.currentTimeMillis();</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                if (!fineEnabled) {</span>
<span class="fc" id="L238">                    System.out.println(&quot;(&quot; + (startSummarizing - start) / 1000 + &quot;sec)&quot;);</span>
                }

<span class="fc" id="L241">                logger.info(&quot;Gathered schema details in &quot; + (startSummarizing - start) / 1000 + &quot; seconds&quot;);</span>
<span class="fc" id="L242">                logger.info(&quot;Writing/graphing summary&quot;);</span>
<span class="fc" id="L243">                System.err.flush();</span>
<span class="fc" id="L244">                System.out.flush();</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">                if (!fineEnabled) {</span>
<span class="fc" id="L246">                    System.out.print(&quot;Writing/graphing summary&quot;);</span>
<span class="fc" id="L247">                    System.out.print(&quot;.&quot;);</span>
                }
<span class="fc" id="L249">                ImageWriter.getInstance().writeImages(outputDir);</span>
<span class="fc" id="L250">                ResourceWriter.getInstance().writeResource(&quot;/jquery.js&quot;, new File(outputDir, &quot;/jquery.js&quot;));</span>
<span class="fc" id="L251">                ResourceWriter.getInstance().writeResource(&quot;/schemaSpy.js&quot;, new File(outputDir, &quot;/schemaSpy.js&quot;));</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L253">                    System.out.print(&quot;.&quot;);</span>

<span class="pc bpc" id="L255" title="1 of 2 branches missed.">                boolean showDetailedTables = tables.size() &lt;= config.getMaxDetailedTables();</span>
<span class="fc" id="L256">                final boolean includeImpliedConstraints = config.isImpliedConstraintsEnabled();</span>

                // if evaluating a 'ruby on rails-based' database then connect the columns
                // based on RoR conventions
                // note that this is done before 'hasRealRelationships' gets evaluated so
                // we get a relationships ER diagram
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">                if (config.isRailsEnabled())</span>
<span class="nc" id="L263">                    DbAnalyzer.getRailsConstraints(db.getTablesByName());</span>

<span class="fc" id="L265">                File diagramsDir = new File(outputDir, &quot;diagrams/summary&quot;);</span>

                // generate the compact form of the relationships .dot file
<span class="fc" id="L268">                String dotBaseFilespec = &quot;relationships&quot;;</span>
<span class="fc" id="L269">                out = new LineWriter(new File(diagramsDir, dotBaseFilespec + &quot;.real.compact.dot&quot;), Config.DOT_CHARSET);</span>
<span class="fc" id="L270">                WriteStats stats = new WriteStats(tables);</span>
<span class="fc" id="L271">                DotFormatter.getInstance().writeRealRelationships(db, tables, true, showDetailedTables, stats, out);</span>
<span class="pc bpc" id="L272" title="3 of 4 branches missed.">                boolean hasRealRelationships = stats.getNumTablesWritten() &gt; 0 || stats.getNumViewsWritten() &gt; 0;</span>
<span class="fc" id="L273">                out.close();</span>

<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                if (hasRealRelationships) {</span>
                    // real relationships exist so generate the 'big' form of the relationships .dot file
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                    if (!fineEnabled)</span>
<span class="fc" id="L278">                        System.out.print(&quot;.&quot;);</span>
<span class="fc" id="L279">                    out = new LineWriter(new File(diagramsDir, dotBaseFilespec + &quot;.real.large.dot&quot;), Config.DOT_CHARSET);</span>
<span class="fc" id="L280">                    DotFormatter.getInstance().writeRealRelationships(db, tables, false, showDetailedTables, stats, out);</span>
<span class="fc" id="L281">                    out.close();</span>
                }

                // getting implied constraints has a side-effect of associating the parent/child tables, so don't do it
                // here unless they want that behavior
<span class="fc" id="L286">                List&lt;ImpliedForeignKeyConstraint&gt; impliedConstraints = null;</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">                if (includeImpliedConstraints)</span>
<span class="fc" id="L288">                    impliedConstraints = DbAnalyzer.getImpliedConstraints(tables);</span>
                else
<span class="fc" id="L290">                    impliedConstraints = new ArrayList&lt;ImpliedForeignKeyConstraint&gt;();</span>

<span class="fc" id="L292">                List&lt;Table&gt; orphans = DbAnalyzer.getOrphans(tables);</span>
<span class="pc bpc" id="L293" title="3 of 4 branches missed.">                boolean hasOrphans = !orphans.isEmpty() &amp;&amp; Dot.getInstance().isValid();</span>

<span class="pc bpc" id="L295" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L296">                    System.out.print(&quot;.&quot;);</span>

<span class="fc" id="L298">                File impliedDotFile = new File(diagramsDir, dotBaseFilespec + &quot;.implied.compact.dot&quot;);</span>
<span class="fc" id="L299">                out = new LineWriter(impliedDotFile, Config.DOT_CHARSET);</span>
<span class="fc" id="L300">                boolean hasImplied = DotFormatter.getInstance().writeAllRelationships(db, tables, true, showDetailedTables, stats, out);</span>

<span class="fc" id="L302">                Set&lt;TableColumn&gt; excludedColumns = stats.getExcludedColumns();</span>
<span class="fc" id="L303">                out.close();</span>
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">                if (hasImplied) {</span>
<span class="nc" id="L305">                    impliedDotFile = new File(diagramsDir, dotBaseFilespec + &quot;.implied.large.dot&quot;);</span>
<span class="nc" id="L306">                    out = new LineWriter(impliedDotFile, Config.DOT_CHARSET);</span>
<span class="nc" id="L307">                    DotFormatter.getInstance().writeAllRelationships(db, tables, false, showDetailedTables, stats, out);</span>
<span class="nc" id="L308">                    out.close();</span>
                } else {
<span class="fc" id="L310">                    impliedDotFile.delete();</span>
                }

<span class="fc" id="L313">                out = new LineWriter(new File(outputDir, dotBaseFilespec + &quot;.html&quot;), config.getCharset());</span>
<span class="fc" id="L314">                HtmlRelationshipsPage.getInstance().write(db, diagramsDir, dotBaseFilespec, hasOrphans, hasRealRelationships, hasImplied, excludedColumns, out);</span>
<span class="fc" id="L315">                out.close();</span>

<span class="pc bpc" id="L317" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L318">                    System.out.print(&quot;.&quot;);</span>

<span class="fc" id="L320">                dotBaseFilespec = &quot;utilities&quot;;</span>
<span class="fc" id="L321">                out = new LineWriter(new File(outputDir, dotBaseFilespec + &quot;.html&quot;), config.getCharset());</span>
<span class="fc" id="L322">                HtmlOrphansPage.getInstance().write(db, orphans, diagramsDir, out);</span>
<span class="fc" id="L323">                out.close();</span>

<span class="pc bpc" id="L325" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L326">                    System.out.print(&quot;.&quot;);</span>

<span class="fc" id="L328">                out = new LineWriter(new File(outputDir, &quot;index.html&quot;), 64 * 1024, config.getCharset());</span>
<span class="fc" id="L329">                HtmlMainIndexPage.getInstance().write(db, tables, hasOrphans, out);</span>
<span class="fc" id="L330">                out.close();</span>

<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L333">                    System.out.print(&quot;.&quot;);</span>

<span class="fc" id="L335">                List&lt;ForeignKeyConstraint&gt; constraints = DbAnalyzer.getForeignKeyConstraints(tables);</span>
<span class="fc" id="L336">                out = new LineWriter(new File(outputDir, &quot;constraints.html&quot;), 256 * 1024, config.getCharset());</span>
<span class="fc" id="L337">                HtmlConstraintsPage constraintIndexFormatter = HtmlConstraintsPage.getInstance();</span>
<span class="fc" id="L338">                constraintIndexFormatter.write(db, constraints, tables, hasOrphans, out);</span>
<span class="fc" id="L339">                out.close();</span>

<span class="pc bpc" id="L341" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L342">                    System.out.print(&quot;.&quot;);</span>

<span class="fc" id="L344">                out = new LineWriter(new File(outputDir, &quot;anomalies.html&quot;), 16 * 1024, config.getCharset());</span>
<span class="fc" id="L345">                HtmlAnomaliesPage.getInstance().write(db, tables, impliedConstraints, hasOrphans, out);</span>
<span class="fc" id="L346">                out.close();</span>

<span class="pc bpc" id="L348" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L349">                    System.out.print(&quot;.&quot;);</span>

<span class="fc bfc" id="L351" title="All 2 branches covered.">                for (HtmlColumnsPage.ColumnInfo columnInfo : HtmlColumnsPage.getInstance().getColumnInfos()) {</span>
<span class="fc" id="L352">                    out = new LineWriter(new File(outputDir, columnInfo.getLocation()), 16 * 1024, config.getCharset());</span>
<span class="fc" id="L353">                    HtmlColumnsPage.getInstance().write(db, tables, columnInfo, hasOrphans, out);</span>
<span class="fc" id="L354">                    out.close();</span>
<span class="fc" id="L355">                }</span>

                // create detailed diagrams

<span class="fc" id="L359">                startDiagrammingDetails = System.currentTimeMillis();</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L361">                    System.out.println(&quot;(&quot; + (startDiagrammingDetails - startSummarizing) / 1000 + &quot;sec)&quot;);</span>
<span class="fc" id="L362">                logger.info(&quot;Completed summary in &quot; + (startDiagrammingDetails - startSummarizing) / 1000 + &quot; seconds&quot;);</span>
<span class="fc" id="L363">                logger.info(&quot;Writing/diagramming details&quot;);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">                if (!fineEnabled) {</span>
<span class="fc" id="L365">                    System.out.print(&quot;Writing/diagramming details&quot;);</span>
                }

<span class="fc" id="L368">                HtmlTablePage tableFormatter = HtmlTablePage.getInstance();</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">                for (Table table : tables) {</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">                    if (!fineEnabled)</span>
<span class="fc" id="L371">                        System.out.print('.');</span>
                    else
<span class="nc" id="L373">                        logger.fine(&quot;Writing details of &quot; + table.getName());</span>

<span class="fc" id="L375">                    out = new LineWriter(new File(outputDir, &quot;tables/&quot; + table.getName() + &quot;.html&quot;), 24 * 1024, config.getCharset());</span>
<span class="fc" id="L376">                    tableFormatter.write(db, table, hasOrphans, outputDir, stats, out);</span>
<span class="fc" id="L377">                    out.close();</span>
<span class="fc" id="L378">                }</span>

<span class="fc" id="L380">                out = new LineWriter(new File(outputDir, &quot;schemaSpy.css&quot;), config.getCharset());</span>
<span class="fc" id="L381">                StyleSheet.getInstance().write(out);</span>
<span class="fc" id="L382">                out.close();</span>
            }


<span class="fc" id="L386">            XmlTableFormatter.getInstance().appendTables(rootNode, tables);</span>

<span class="fc" id="L388">            String xmlName = dbName;</span>

            // some dbNames have path info in the name...strip it
<span class="fc" id="L391">            xmlName = new File(xmlName).getName();</span>

<span class="pc bpc" id="L393" title="1 of 2 branches missed.">            if (schema != null)</span>
<span class="nc" id="L394">                xmlName += '.' + schema;</span>

<span class="fc" id="L396">            out = new LineWriter(new File(outputDir, xmlName + &quot;.xml&quot;), Config.DOT_CHARSET);</span>
<span class="fc" id="L397">            document.getDocumentElement().normalize();</span>
<span class="fc" id="L398">            DOMUtil.printDOM(document, out);</span>
<span class="fc" id="L399">            out.close();</span>

            // 'try' to make some memory available for the sorting process
            // (some people have run out of memory while RI sorting tables)
<span class="fc" id="L403">            builder = null;</span>
<span class="fc" id="L404">            connection = null;</span>
<span class="fc" id="L405">            document = null;</span>
<span class="fc" id="L406">            factory = null;</span>
<span class="fc" id="L407">            meta = null;</span>
<span class="fc" id="L408">            properties = null;</span>
<span class="fc" id="L409">            rootNode = null;</span>
<span class="fc" id="L410">            urlBuilder = null;</span>

<span class="fc" id="L412">            List&lt;ForeignKeyConstraint&gt; recursiveConstraints = new ArrayList&lt;ForeignKeyConstraint&gt;();</span>

            // create an orderer to be able to determine insertion and deletion ordering of tables
<span class="fc" id="L415">            TableOrderer orderer = new TableOrderer();</span>

            // side effect is that the RI relationships get trashed
            // also populates the recursiveConstraints collection
<span class="fc" id="L419">            List&lt;Table&gt; orderedTables = orderer.getTablesOrderedByRI(db.getTables(), recursiveConstraints);</span>

<span class="fc" id="L421">            out = new LineWriter(new File(outputDir, &quot;insertionOrder.txt&quot;), 16 * 1024, Config.DOT_CHARSET);</span>
<span class="fc" id="L422">            TextFormatter.getInstance().write(orderedTables, false, out);</span>
<span class="fc" id="L423">            out.close();</span>

<span class="fc" id="L425">            out = new LineWriter(new File(outputDir, &quot;deletionOrder.txt&quot;), 16 * 1024, Config.DOT_CHARSET);</span>
<span class="fc" id="L426">            Collections.reverse(orderedTables);</span>
<span class="fc" id="L427">            TextFormatter.getInstance().write(orderedTables, false, out);</span>
<span class="fc" id="L428">            out.close();</span>

            /* we'll eventually want to put this functionality back in with a
             * database independent implementation
            File constraintsFile = new File(outputDir, &quot;removeRecursiveConstraints.sql&quot;);
            constraintsFile.delete();
            if (!recursiveConstraints.isEmpty()) {
                out = new LineWriter(constraintsFile, 4 * 1024);
                writeRemoveRecursiveConstraintsSql(recursiveConstraints, schema, out);
                out.close();
            }

            constraintsFile = new File(outputDir, &quot;restoreRecursiveConstraints.sql&quot;);
            constraintsFile.delete();

            if (!recursiveConstraints.isEmpty()) {
                out = new LineWriter(constraintsFile, 4 * 1024);
                writeRestoreRecursiveConstraintsSql(recursiveConstraints, schema, out);
                out.close();
            }
            */

<span class="pc bpc" id="L450" title="1 of 2 branches missed.">            if (config.isHtmlGenerationEnabled()) {</span>
<span class="fc" id="L451">                long end = System.currentTimeMillis();</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">                if (!fineEnabled)</span>
<span class="fc" id="L453">                    System.out.println(&quot;(&quot; + (end - startDiagrammingDetails) / 1000 + &quot;sec)&quot;);</span>
<span class="fc" id="L454">                logger.info(&quot;Wrote table details in &quot; + (end - startDiagrammingDetails) / 1000 + &quot; seconds&quot;);</span>

<span class="pc bpc" id="L456" title="1 of 2 branches missed.">                if (logger.isLoggable(Level.INFO)) {</span>
<span class="nc" id="L457">                    logger.info(&quot;Wrote relationship details of &quot; + tables.size() + &quot; tables/views to directory '&quot; + config.getOutputDir() + &quot;' in &quot; + (end - start) / 1000 + &quot; seconds.&quot;);</span>
<span class="nc" id="L458">                    logger.info(&quot;View the results by opening &quot; + new File(config.getOutputDir(), &quot;index.html&quot;));</span>
                } else {
<span class="fc" id="L460">                    System.out.println(&quot;Wrote relationship details of &quot; + tables.size() + &quot; tables/views to directory '&quot; + config.getOutputDir() + &quot;' in &quot; + (end - start) / 1000 + &quot; seconds.&quot;);</span>
<span class="fc" id="L461">                    System.out.println(&quot;View the results by opening &quot; + new File(config.getOutputDir(), &quot;index.html&quot;));</span>
                }
            }

<span class="fc" id="L465">            return db;</span>
<span class="nc" id="L466">        } catch (Config.MissingRequiredParameterException missingParam) {</span>
<span class="nc" id="L467">            config.dumpUsage(missingParam.getMessage(), missingParam.isDbTypeSpecific());</span>
<span class="nc" id="L468">            return null;</span>
        }
    }

    /**
     * dumpNoDataMessage
     *
     * @param schema String
     * @param user String
     * @param meta DatabaseMetaData
     */
    private static void dumpNoTablesMessage(String schema, String user, DatabaseMetaData meta, boolean specifiedInclusions) throws SQLException {
<span class="nc" id="L480">        System.out.println();</span>
<span class="nc" id="L481">        System.out.println();</span>
<span class="nc" id="L482">        System.out.println(&quot;No tables or views were found in schema '&quot; + schema + &quot;'.&quot;);</span>
<span class="nc" id="L483">        List&lt;String&gt; schemas = DbAnalyzer.getSchemas(meta);</span>
<span class="nc bnc" id="L484" title="All 4 branches missed.">        if (schema == null || schemas.contains(schema)) {</span>
<span class="nc" id="L485">            System.out.println(&quot;The schema exists in the database, but the user you specified (&quot; + user + ')');</span>
<span class="nc" id="L486">            System.out.println(&quot;  might not have rights to read its contents.&quot;);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (specifiedInclusions) {</span>
<span class="nc" id="L488">                System.out.println(&quot;Another possibility is that the regular expression that you specified&quot;);</span>
<span class="nc" id="L489">                System.out.println(&quot;  for what to include (via -i) didn't match any tables.&quot;);</span>
            }
        } else {
<span class="nc" id="L492">            System.out.println(&quot;The schema does not exist in the database.&quot;);</span>
<span class="nc" id="L493">            System.out.println(&quot;Make sure that you specify a valid schema with the -s option and that&quot;);</span>
<span class="nc" id="L494">            System.out.println(&quot;  the user specified (&quot; + user + &quot;) can read from the schema.&quot;);</span>
<span class="nc" id="L495">            System.out.println(&quot;Note that schema names are usually case sensitive.&quot;);</span>
        }
<span class="nc" id="L497">        System.out.println();</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        boolean plural = schemas.size() != 1;</span>
<span class="nc bnc" id="L499" title="All 4 branches missed.">        System.out.println(schemas.size() + &quot; schema&quot; + (plural ? &quot;s&quot; : &quot;&quot;) + &quot; exist&quot; + (plural ? &quot;&quot; : &quot;s&quot;) + &quot; in this database.&quot;);</span>
<span class="nc" id="L500">        System.out.println(&quot;Some of these \&quot;schemas\&quot; may be users or system schemas.&quot;);</span>
<span class="nc" id="L501">        System.out.println();</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">        for (String unknown : schemas) {</span>
<span class="nc" id="L503">            System.out.print(unknown + &quot; &quot;);</span>
<span class="nc" id="L504">        }</span>

<span class="nc" id="L506">        System.out.println();</span>
<span class="nc" id="L507">        List&lt;String&gt; populatedSchemas = DbAnalyzer.getPopulatedSchemas(meta);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (populatedSchemas.isEmpty()) {</span>
<span class="nc" id="L509">            System.out.println(&quot;Unable to determine if any of the schemas contain tables/views&quot;);</span>
        } else {
<span class="nc" id="L511">            System.out.println(&quot;These schemas contain tables/views that user '&quot; + user + &quot;' can see:&quot;);</span>
<span class="nc" id="L512">            System.out.println();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">            for (String populated : populatedSchemas) {</span>
<span class="nc" id="L514">                System.out.print(&quot; &quot; + populated);</span>
<span class="nc" id="L515">            }</span>
        }
<span class="nc" id="L517">    }</span>

    private Connection getConnection(Config config, String connectionURL,
                      String driverClass, String driverPath) throws FileNotFoundException, IOException {
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">        if (logger.isLoggable(Level.INFO)) {</span>
<span class="nc" id="L522">            logger.info(&quot;Using database properties:&quot;);</span>
<span class="nc" id="L523">            logger.info(&quot;  &quot; + config.getDbPropertiesLoadedFrom());</span>
        } else {
<span class="fc" id="L525">            System.out.println(&quot;Using database properties:&quot;);</span>
<span class="fc" id="L526">            System.out.println(&quot;  &quot; + config.getDbPropertiesLoadedFrom());</span>
        }

<span class="fc" id="L529">        List&lt;URL&gt; classpath = new ArrayList&lt;URL&gt;();</span>
<span class="fc" id="L530">        List&lt;File&gt; invalidClasspathEntries = new ArrayList&lt;File&gt;();</span>
<span class="fc" id="L531">        StringTokenizer tokenizer = new StringTokenizer(driverPath, File.pathSeparator);</span>
<span class="fc bfc" id="L532" title="All 2 branches covered.">        while (tokenizer.hasMoreTokens()) {</span>
<span class="fc" id="L533">            File pathElement = new File(tokenizer.nextToken());</span>
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">            if (pathElement.exists())</span>
<span class="nc" id="L535">                classpath.add(pathElement.toURI().toURL());</span>
            else
<span class="fc" id="L537">                invalidClasspathEntries.add(pathElement);</span>
<span class="fc" id="L538">        }</span>

<span class="fc" id="L540">        URLClassLoader loader = new URLClassLoader(classpath.toArray(new URL[classpath.size()]));</span>
<span class="fc" id="L541">        Driver driver = null;</span>
        try {
<span class="fc" id="L543">            driver = (Driver)Class.forName(driverClass, true, loader).newInstance();</span>

            // have to use deprecated method or we won't see messages generated by older drivers
            //java.sql.DriverManager.setLogStream(System.err);
<span class="nc" id="L547">        } catch (Exception exc) {</span>
<span class="nc" id="L548">            System.err.println(exc); // people don't want to see a stack trace...</span>
<span class="nc" id="L549">            System.err.println();</span>
<span class="nc" id="L550">            System.err.print(&quot;Failed to load driver '&quot; + driverClass + &quot;'&quot;);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">            if (classpath.isEmpty())</span>
<span class="nc" id="L552">                System.err.println();</span>
            else
<span class="nc" id="L554">                System.err.println(&quot;from: &quot; + classpath);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (!invalidClasspathEntries.isEmpty()) {</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                if (invalidClasspathEntries.size() == 1)</span>
<span class="nc" id="L557">                    System.err.print(&quot;This entry doesn't point to a valid file/directory: &quot;);</span>
                else
<span class="nc" id="L559">                    System.err.print(&quot;These entries don't point to valid files/directories: &quot;);</span>
<span class="nc" id="L560">                System.err.println(invalidClasspathEntries);</span>
            }
<span class="nc" id="L562">            System.err.println();</span>
<span class="nc" id="L563">            System.err.println(&quot;Use the -dp option to specify the location of the database&quot;);</span>
<span class="nc" id="L564">            System.err.println(&quot;drivers for your database (usually in a .jar or .zip/.Z).&quot;);</span>
<span class="nc" id="L565">            System.err.println();</span>
<span class="nc" id="L566">            throw new ConnectionFailure(exc);</span>
<span class="fc" id="L567">        }</span>

<span class="fc" id="L569">        Properties connectionProperties = config.getConnectionProperties();</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">        if (config.getUser() != null) {</span>
<span class="nc" id="L571">            connectionProperties.put(&quot;user&quot;, config.getUser());</span>
        }
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">        if (config.getPassword() != null) {</span>
<span class="nc" id="L574">            connectionProperties.put(&quot;password&quot;, config.getPassword());</span>
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">        } else if (config.isPromptForPasswordEnabled()) {</span>
<span class="nc" id="L576">            connectionProperties.put(&quot;password&quot;,</span>
<span class="nc" id="L577">                    new String(PasswordReader.getInstance().readPassword(&quot;Password: &quot;)));</span>
        }

<span class="fc" id="L580">        Connection connection = null;</span>
        try {
<span class="fc" id="L582">            connection = driver.connect(connectionURL, connectionProperties);</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">            if (connection == null) {</span>
<span class="nc" id="L584">                System.err.println();</span>
<span class="nc" id="L585">                System.err.println(&quot;Cannot connect to this database URL:&quot;);</span>
<span class="nc" id="L586">                System.err.println(&quot;  &quot; + connectionURL);</span>
<span class="nc" id="L587">                System.err.println(&quot;with this driver:&quot;);</span>
<span class="nc" id="L588">                System.err.println(&quot;  &quot; + driverClass);</span>
<span class="nc" id="L589">                System.err.println();</span>
<span class="nc" id="L590">                System.err.println(&quot;Additional connection information may be available in &quot;);</span>
<span class="nc" id="L591">                System.err.println(&quot;  &quot; + config.getDbPropertiesLoadedFrom());</span>
<span class="nc" id="L592">                throw new ConnectionFailure(&quot;Cannot connect to '&quot; + connectionURL +&quot;' with driver '&quot; + driverClass + &quot;'&quot;);</span>
            }
<span class="nc" id="L594">        } catch (UnsatisfiedLinkError badPath) {</span>
<span class="nc" id="L595">            System.err.println();</span>
<span class="nc" id="L596">            System.err.println(&quot;Failed to load driver [&quot; + driverClass + &quot;] from classpath &quot; + classpath);</span>
<span class="nc" id="L597">            System.err.println();</span>
<span class="nc" id="L598">            System.err.println(&quot;Make sure the reported library (.dll/.lib/.so) from the following line can be&quot;);</span>
<span class="nc" id="L599">            System.err.println(&quot;found by your PATH (or LIB*PATH) environment variable&quot;);</span>
<span class="nc" id="L600">            System.err.println();</span>
<span class="nc" id="L601">            badPath.printStackTrace();</span>
<span class="nc" id="L602">            throw new ConnectionFailure(badPath);</span>
<span class="nc" id="L603">        } catch (Exception exc) {</span>
<span class="nc" id="L604">            System.err.println();</span>
<span class="nc" id="L605">            System.err.println(&quot;Failed to connect to database URL [&quot; + connectionURL + &quot;]&quot;);</span>
<span class="nc" id="L606">            System.err.println();</span>
<span class="nc" id="L607">            exc.printStackTrace();</span>
<span class="nc" id="L608">            throw new ConnectionFailure(exc);</span>
<span class="fc" id="L609">        }</span>

<span class="fc" id="L611">        return connection;</span>
    }

    /**
     * Currently very DB2-specific
     * @param recursiveConstraints List
     * @param schema String
     * @param out LineWriter
     * @throws IOException
     */
    /* we'll eventually want to put this functionality back in with a
     * database independent implementation
    private static void writeRemoveRecursiveConstraintsSql(List recursiveConstraints, String schema, LineWriter out) throws IOException {
        for (Iterator iter = recursiveConstraints.iterator(); iter.hasNext(); ) {
            ForeignKeyConstraint constraint = (ForeignKeyConstraint)iter.next();
            out.writeln(&quot;ALTER TABLE &quot; + schema + &quot;.&quot; + constraint.getChildTable() + &quot; DROP CONSTRAINT &quot; + constraint.getName() + &quot;;&quot;);
        }
    }
    */

    /**
     * Currently very DB2-specific
     * @param recursiveConstraints List
     * @param schema String
     * @param out LineWriter
     * @throws IOException
     */
    /* we'll eventually want to put this functionality back in with a
     * database independent implementation
    private static void writeRestoreRecursiveConstraintsSql(List recursiveConstraints, String schema, LineWriter out) throws IOException {
        Map ruleTextMapping = new HashMap();
        ruleTextMapping.put(new Character('C'), &quot;CASCADE&quot;);
        ruleTextMapping.put(new Character('A'), &quot;NO ACTION&quot;);
        ruleTextMapping.put(new Character('N'), &quot;NO ACTION&quot;); // Oracle
        ruleTextMapping.put(new Character('R'), &quot;RESTRICT&quot;);
        ruleTextMapping.put(new Character('S'), &quot;SET NULL&quot;);  // Oracle

        for (Iterator iter = recursiveConstraints.iterator(); iter.hasNext(); ) {
            ForeignKeyConstraint constraint = (ForeignKeyConstraint)iter.next();
            out.write(&quot;ALTER TABLE \&quot;&quot; + schema + &quot;\&quot;.\&quot;&quot; + constraint.getChildTable() + &quot;\&quot; ADD CONSTRAINT \&quot;&quot; + constraint.getName() + &quot;\&quot;&quot;);
            StringBuffer buf = new StringBuffer();
            for (Iterator columnIter = constraint.getChildColumns().iterator(); columnIter.hasNext(); ) {
                buf.append(&quot;\&quot;&quot;);
                buf.append(columnIter.next());
                buf.append(&quot;\&quot;&quot;);
                if (columnIter.hasNext())
                    buf.append(&quot;,&quot;);
            }
            out.write(&quot; FOREIGN KEY (&quot; + buf.toString() + &quot;)&quot;);
            out.write(&quot; REFERENCES \&quot;&quot; + schema + &quot;\&quot;.\&quot;&quot; + constraint.getParentTable() + &quot;\&quot;&quot;);
            buf = new StringBuffer();
            for (Iterator columnIter = constraint.getParentColumns().iterator(); columnIter.hasNext(); ) {
                buf.append(&quot;\&quot;&quot;);
                buf.append(columnIter.next());
                buf.append(&quot;\&quot;&quot;);
                if (columnIter.hasNext())
                    buf.append(&quot;,&quot;);
            }
            out.write(&quot; (&quot; + buf.toString() + &quot;)&quot;);
            out.write(&quot; ON DELETE &quot;);
            out.write(ruleTextMapping.get(new Character(constraint.getDeleteRule())).toString());
            out.write(&quot; ON UPDATE &quot;);
            out.write(ruleTextMapping.get(new Character(constraint.getUpdateRule())).toString());
            out.writeln(&quot;;&quot;);
        }
    }
    */

    private static void yankParam(List&lt;String&gt; args, String paramId) {
<span class="nc" id="L680">        int paramIndex = args.indexOf(paramId);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (paramIndex &gt;= 0) {</span>
<span class="nc" id="L682">            args.remove(paramIndex);</span>
<span class="nc" id="L683">            args.remove(paramIndex);</span>
        }
<span class="nc" id="L685">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>