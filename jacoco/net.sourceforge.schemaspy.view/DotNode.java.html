<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DotNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SchemaSpy Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.schemaspy.view</a> &gt; <span class="el_source">DotNode.java</span></div><h1>DotNode.java</h1><pre class="source lang-java linenums">/*
 * This file is a part of the SchemaSpy project (http://schemaspy.sourceforge.net).
 * Copyright (C) 2004, 2005, 2006, 2007, 2008, 2009, 2010 John Currier
 *
 * SchemaSpy is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * SchemaSpy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
 */
package net.sourceforge.schemaspy.view;

import java.text.NumberFormat;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import net.sourceforge.schemaspy.Config;
import net.sourceforge.schemaspy.model.Table;
import net.sourceforge.schemaspy.model.TableColumn;
import net.sourceforge.schemaspy.model.TableIndex;
import net.sourceforge.schemaspy.util.URLEncoder;

public class DotNode {
    private final Table table;
    private final DotNodeConfig config;
    private final String path;
<span class="fc" id="L35">    private final Set&lt;TableColumn&gt; excludedColumns = new HashSet&lt;TableColumn&gt;();</span>
<span class="fc" id="L36">    private final String lineSeparator = System.getProperty(&quot;line.separator&quot;);</span>
<span class="fc" id="L37">    private final boolean displayNumRows = Config.getInstance().isNumRowsEnabled();</span>
<span class="fc" id="L38">    private static final URLEncoder urlEncoder = new URLEncoder(Config.DOT_CHARSET);</span>

    /**
     * Create a DotNode that is a focal point of a diagram.
     * That is, all of its columns are displayed in addition to the details
     * of those columns.
     *
     * @param table Table
     * @param path String
     */
    public DotNode(Table table, String path) {
<span class="fc" id="L49">        this(table, path, new DotNodeConfig(true, true));</span>
<span class="fc" id="L50">    }</span>

<span class="fc" id="L52">    public DotNode(Table table, String path, DotNodeConfig config) {</span>
<span class="fc" id="L53">        this.table = table;</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        this.path = path + (table.isRemote() ? (&quot;../../&quot; + table.getSchema() + &quot;/tables/&quot;) : &quot;&quot;);</span>
<span class="fc" id="L55">        this.config = config;</span>
<span class="fc" id="L56">    }</span>

    /**
     * Create a DotNode and specify whether it displays its columns.
     * The details of the optional columns (e.g. type, size) are not displayed.
     *
     * @param table Table
     * @param showColumns boolean
     * @param path String
     */
    public DotNode(Table table, boolean showColumns, String path) {
<span class="fc bfc" id="L67" title="All 2 branches covered.">        this(table, path, showColumns ? new DotNodeConfig(true, false) : new DotNodeConfig());</span>
<span class="fc" id="L68">    }</span>

    public void setShowImplied(boolean showImplied) {
<span class="nc" id="L71">        config.showImpliedRelationships = showImplied;</span>
<span class="nc" id="L72">    }</span>

    public Table getTable() {
<span class="fc" id="L75">        return table;</span>
    }

    public void excludeColumn(TableColumn column) {
<span class="nc" id="L79">        excludedColumns.add(column);</span>
<span class="nc" id="L80">    }</span>

    @Override
    public String toString() {
<span class="fc" id="L84">        StyleSheet css = StyleSheet.getInstance();</span>
<span class="fc" id="L85">        StringBuilder buf = new StringBuilder();</span>
<span class="fc" id="L86">        String tableName = table.getName();</span>
        // fully qualified table name (optionally prefixed with schema)
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        String fqTableName = (table.isRemote() ? table.getSchema() + &quot;.&quot; : &quot;&quot;) + tableName;</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        String colspan = config.showColumnDetails ? &quot;COLSPAN=\&quot;2\&quot; &quot; : &quot;COLSPAN=\&quot;3\&quot; &quot;;</span>

<span class="fc" id="L91">        buf.append(&quot;  \&quot;&quot; + fqTableName + &quot;\&quot; [&quot; + lineSeparator);</span>
<span class="fc" id="L92">        buf.append(&quot;    label=&lt;&quot; + lineSeparator);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        buf.append(&quot;    &lt;TABLE BORDER=\&quot;&quot; + (config.showColumnDetails ? &quot;2&quot; : &quot;0&quot;) + &quot;\&quot; CELLBORDER=\&quot;1\&quot; CELLSPACING=\&quot;0\&quot; BGCOLOR=\&quot;&quot; + css.getTableBackground() + &quot;\&quot;&gt;&quot; + lineSeparator);</span>
<span class="fc" id="L94">        buf.append(&quot;      &lt;TR&gt;&quot;);</span>
<span class="fc" id="L95">        buf.append(&quot;&lt;TD COLSPAN=\&quot;3\&quot; BGCOLOR=\&quot;&quot; + css.getTableHeadBackground() + &quot;\&quot; ALIGN=\&quot;CENTER\&quot;&gt;&quot; + fqTableName + &quot;&lt;/TD&gt;&quot;);</span>
<span class="fc" id="L96">        buf.append(&quot;&lt;/TR&gt;&quot; + lineSeparator);</span>

<span class="fc" id="L98">        boolean skippedTrivial = false;</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (config.showColumns) {</span>
<span class="fc" id="L101">            List&lt;TableColumn&gt; primaryColumns = table.getPrimaryColumns();</span>
<span class="fc" id="L102">            Set&lt;TableColumn&gt; indexColumns = new HashSet&lt;TableColumn&gt;();</span>

<span class="fc bfc" id="L104" title="All 2 branches covered.">            for (TableIndex index : table.getIndexes()) {</span>
<span class="fc" id="L105">                indexColumns.addAll(index.getColumns());</span>
<span class="fc" id="L106">            }</span>
<span class="fc" id="L107">            indexColumns.removeAll(primaryColumns);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">            for (TableColumn column : table.getColumns()) {</span>
<span class="pc bpc" id="L110" title="2 of 10 branches missed.">                if (config.showTrivialColumns || config.showColumnDetails || column.isPrimary() || column.isForeignKey() || indexColumns.contains(column)) {</span>
<span class="fc" id="L111">                    buf.append(&quot;      &lt;TR&gt;&quot;);</span>
<span class="fc" id="L112">                    buf.append(&quot;&lt;TD PORT=\&quot;&quot; + column.getName() + &quot;\&quot; &quot; + colspan);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                    if (excludedColumns.contains(column))</span>
<span class="nc" id="L114">                        buf.append(&quot;BGCOLOR=\&quot;&quot; + css.getExcludedColumnBackgroundColor() + &quot;\&quot; &quot;);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">                    else if (primaryColumns.contains(column))</span>
<span class="fc" id="L116">                        buf.append(&quot;BGCOLOR=\&quot;&quot; + css.getPrimaryKeyBackground() + &quot;\&quot; &quot;);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">                    else if (indexColumns.contains(column))</span>
<span class="fc" id="L118">                        buf.append(&quot;BGCOLOR=\&quot;&quot; + css.getIndexedColumnBackground() + &quot;\&quot; &quot;);</span>
<span class="fc" id="L119">                    buf.append(&quot;ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L120">                    buf.append(column.getName());</span>
<span class="fc" id="L121">                    buf.append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                    if (config.showColumnDetails) {</span>
<span class="fc" id="L123">                        buf.append(&quot;&lt;TD PORT=\&quot;&quot;);</span>
<span class="fc" id="L124">                        buf.append(column.getName());</span>
<span class="fc" id="L125">                        buf.append(&quot;.type\&quot; ALIGN=\&quot;LEFT\&quot;&gt;&quot;);</span>
<span class="fc" id="L126">                        buf.append(column.getType().toLowerCase());</span>
<span class="fc" id="L127">                        buf.append(&quot;[&quot;);</span>
<span class="fc" id="L128">                        buf.append(column.getDetailedSize());</span>
<span class="fc" id="L129">                        buf.append(&quot;]&lt;/TD&gt;&quot;);</span>
                    }
<span class="fc" id="L131">                    buf.append(&quot;&lt;/TR&gt;&quot; + lineSeparator);</span>
                } else {
<span class="fc" id="L133">                    skippedTrivial = true;</span>
                }
<span class="fc" id="L135">            }</span>
        }

<span class="fc bfc" id="L138" title="All 4 branches covered.">        if (skippedTrivial || !config.showColumns) {</span>
<span class="fc" id="L139">            buf.append(&quot;      &lt;TR&gt;&lt;TD PORT=\&quot;elipses\&quot; COLSPAN=\&quot;3\&quot; ALIGN=\&quot;LEFT\&quot;&gt;...&lt;/TD&gt;&lt;/TR&gt;&quot; + lineSeparator);</span>
        }

<span class="fc" id="L142">        buf.append(&quot;      &lt;TR&gt;&quot;);</span>
<span class="fc" id="L143">        buf.append(&quot;&lt;TD ALIGN=\&quot;LEFT\&quot; BGCOLOR=\&quot;&quot; + css.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        int numParents = config.showImpliedRelationships ? table.getNumParents() : table.getNumNonImpliedParents();</span>
<span class="fc bfc" id="L145" title="All 4 branches covered.">        if (numParents &gt; 0 || config.showColumnDetails)</span>
<span class="fc" id="L146">            buf.append(&quot;&amp;lt; &quot; + numParents);</span>
        else
<span class="fc" id="L148">            buf.append(&quot;  &quot;);</span>
<span class="fc" id="L149">        buf.append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="fc" id="L150">        buf.append(&quot;&lt;TD ALIGN=\&quot;RIGHT\&quot; BGCOLOR=\&quot;&quot; + css.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (table.isView())</span>
<span class="nc" id="L152">            buf.append(&quot;view&quot;);</span>
        else {
<span class="fc" id="L154">            final long numRows = table.getNumRows();</span>
<span class="pc bpc" id="L155" title="2 of 4 branches missed.">            if (displayNumRows &amp;&amp; numRows != -1) {</span>
<span class="fc" id="L156">                buf.append(NumberFormat.getInstance().format(numRows));</span>
<span class="fc" id="L157">                buf.append(&quot; row&quot;);</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">                if (numRows != 1)</span>
<span class="fc" id="L159">                    buf.append('s');</span>
            } else {
<span class="nc" id="L161">                buf.append(&quot;  &quot;);</span>
            }
        }
<span class="fc" id="L164">        buf.append(&quot;&lt;/TD&gt;&quot;);</span>
<span class="fc" id="L165">        buf.append(&quot;&lt;TD ALIGN=\&quot;RIGHT\&quot; BGCOLOR=\&quot;&quot; + css.getBodyBackground() + &quot;\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        int numChildren = config.showImpliedRelationships ? table.getNumChildren() : table.getNumNonImpliedChildren();</span>
<span class="fc bfc" id="L167" title="All 4 branches covered.">        if (numChildren &gt; 0 || config.showColumnDetails)</span>
<span class="fc" id="L168">            buf.append(numChildren + &quot; &amp;gt;&quot;);</span>
        else
<span class="fc" id="L170">            buf.append(&quot;  &quot;);</span>
<span class="fc" id="L171">        buf.append(&quot;&lt;/TD&gt;&lt;/TR&gt;&quot; + lineSeparator);</span>

<span class="fc" id="L173">        buf.append(&quot;    &lt;/TABLE&gt;&gt;&quot; + lineSeparator);</span>
<span class="pc bpc" id="L174" title="3 of 4 branches missed.">        if (!table.isRemote() || Config.getInstance().isOneOfMultipleSchemas())</span>
<span class="fc" id="L175">            buf.append(&quot;    URL=\&quot;&quot; + path + toNCR( urlEncoder.encode(tableName) ) + &quot;.html\&quot;&quot; + lineSeparator);</span>
<span class="fc" id="L176">        buf.append(&quot;    tooltip=\&quot;&quot; + toNCR(fqTableName) + &quot;\&quot;&quot; + lineSeparator);</span>
<span class="fc" id="L177">        buf.append(&quot;  ];&quot;);</span>

<span class="fc" id="L179">        return buf.toString();</span>
    }

    /**
     * Translates specified string to Numeric Character Reference (NCR).
     * This (hopefully) allows Unicode languages to be displayed correctly.&lt;p&gt;
     * The basis for this code was found
     * &lt;a href='http://d.hatena.ne.jp/etherealmaro/20060806#1154886500'&gt;here&lt;/a&gt;.
     *
     * @param str
     * @return
     */
    private static String toNCR(String str) {
<span class="fc" id="L192">        StringBuilder result = new StringBuilder();</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">        for (int i = 0; i &lt; str.length(); ++i) {</span>
<span class="fc" id="L194">            char ch = str.charAt(i);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if (ch &lt;= 127) {    // don't confuse things unless necessary</span>
<span class="fc" id="L196">                result.append(ch);</span>
            } else {
<span class="nc" id="L198">                result.append(&quot;&amp;#&quot;);</span>
<span class="nc" id="L199">                result.append(Integer.parseInt(Integer.toHexString(ch), 16));</span>
<span class="nc" id="L200">                result.append(&quot;;&quot;);</span>
            }
        }
<span class="fc" id="L203">        return result.toString();</span>
    }

    public static class DotNodeConfig {
        private final boolean showColumns;
        private boolean showTrivialColumns;
        private final boolean showColumnDetails;
        private boolean showImpliedRelationships;

        /**
         * Nothing but table name and counts are displayed
         */
<span class="fc" id="L215">        public DotNodeConfig() {</span>
<span class="fc" id="L216">            showColumns = showTrivialColumns = showColumnDetails = showImpliedRelationships = false;</span>
<span class="fc" id="L217">        }</span>

<span class="fc" id="L219">        public DotNodeConfig(boolean showTrivialColumns, boolean showColumnDetails) {</span>
<span class="fc" id="L220">            showColumns = true;</span>
<span class="fc" id="L221">            this.showTrivialColumns = showTrivialColumns;</span>
<span class="fc" id="L222">            this.showColumnDetails = showColumnDetails;</span>
<span class="fc" id="L223">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>